name: Wails Release

on:
  push:
    tags:
      - 'v*'
  workflow_call:
    inputs:
      tag:
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [arm64, amd64]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - uses: pnpm/action-setup@v4
        with:
          package_json_file: web/package.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: cd web && pnpm install

      - name: Build frontend
        run: cd web && pnpm build

      - name: Build macOS ${{ matrix.arch }}
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          VERSION=${TAG#v}
          wails build -platform darwin/${{ matrix.arch }} -ldflags "-X github.com/awsl-project/maxx/internal/version.Version=$VERSION" -clean

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG and generate checksum
        run: |
          cd build/bin
          # Find the .app bundle
          APP_NAME=$(ls -d *.app | head -n 1)
          if [ -z "$APP_NAME" ]; then
            echo "App bundle not found" >&2
            ls -la
            exit 1
          fi
          echo "Found app: $APP_NAME"

          # Create DMG with Applications folder shortcut
          DMG_NAME="maxx-macOS-${{ matrix.arch }}.dmg"
          create-dmg \
            --volname "maxx" \
            --volicon "../../build/appicon.png" \
            --window-pos 200 120 \
            --window-size 660 400 \
            --icon-size 100 \
            --icon "$APP_NAME" 180 170 \
            --hide-extension "$APP_NAME" \
            --app-drop-link 480 170 \
            "$DMG_NAME" \
            "$APP_NAME"

          # Generate SHA256
          shasum -a 256 "$DMG_NAME" | awk '{print $1}' > "${DMG_NAME}.sha256"

          # Move to bin directory
          cd ../..
          mkdir -p bin
          mv "build/bin/$DMG_NAME" bin/
          mv "build/bin/${DMG_NAME}.sha256" bin/

          echo "Created: bin/$DMG_NAME"
          ls -lh bin/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: |
            bin/maxx-macOS-${{ matrix.arch }}.dmg
            bin/maxx-macOS-${{ matrix.arch }}.dmg.sha256

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - uses: pnpm/action-setup@v4
        with:
          package_json_file: web/package.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: cd web && pnpm install

      - name: Build frontend
        run: cd web && pnpm build

      - name: Build Windows Binary
        run: |
          $TAG = "${{ inputs.tag || github.ref_name }}"
          $VERSION = $TAG.TrimStart('v')
          wails build -platform windows/amd64 -ldflags "-X github.com/awsl-project/maxx/internal/version.Version=$VERSION" -clean

      - name: Verify and prepare Binary
        run: |
          # Wails v2 outputs to build/bin
          if (Test-Path "build\bin\maxx.exe") {
            Write-Host "âœ“ Binary found: build\bin\maxx.exe"
            # Copy to bin directory
            New-Item -ItemType Directory -Force -Path bin
            Copy-Item "build\bin\maxx.exe" "bin\maxx.exe"
            Get-Item "bin\maxx.exe" | Format-List Name,Length,LastWriteTime
          } else {
            Write-Host "âœ— Binary not found!"
            Write-Host "Listing build/bin directory:"
            Get-ChildItem build\bin -ErrorAction SilentlyContinue
            exit 1
          }

      - name: Generate SHA256 Checksums
        run: |
          Push-Location bin
          Get-FileHash -Algorithm SHA256 maxx.exe | ForEach-Object { "$($_.Hash.ToLower())  maxx.exe" } | Out-File -Encoding ascii maxx.exe.sha256
          Write-Host "SHA256 checksum generated:"
          Get-Content maxx.exe.sha256
          Pop-Location

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-amd64
          path: |
            bin/maxx.exe
            bin/maxx.exe.sha256

  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Linux Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev

      - uses: pnpm/action-setup@v4
        with:
          package_json_file: web/package.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: cd web && pnpm install

      - name: Build frontend
        run: cd web && pnpm build

      - name: Build Linux Binary
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          VERSION=${TAG#v}
          wails build -platform linux/amd64 -ldflags "-X github.com/awsl-project/maxx/internal/version.Version=$VERSION" -clean

      - name: Prepare binary
        run: |
          # Wails v2 outputs to build/bin
          mkdir -p bin
          if [ -f "build/bin/maxx" ]; then
            cp build/bin/maxx bin/maxx
            chmod +x bin/maxx
            echo "Binary prepared: bin/maxx"
            ls -lh bin/maxx
          else
            echo "Binary not found!"
            ls -la build/bin/
            exit 1
          fi

      - name: Generate SHA256 Checksum
        run: |
          cd bin
          sha256sum maxx > maxx.sha256
          echo "SHA256 checksum:"
          cat maxx.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-amd64
          path: |
            bin/maxx
            bin/maxx.sha256

  create-release:
    name: Create Release
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: '{macos,windows,linux}-*'
          merge-multiple: false

      - name: Display structure
        run: ls -R artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # macOS
          cp artifacts/macos-arm64/maxx-macOS-arm64.dmg release-assets/ 2>/dev/null || echo "macOS arm64 not found"
          cp artifacts/macos-arm64/maxx-macOS-arm64.dmg.sha256 release-assets/ 2>/dev/null || echo "macOS arm64 checksum not found"
          cp artifacts/macos-amd64/maxx-macOS-amd64.dmg release-assets/ 2>/dev/null || echo "macOS amd64 not found"
          cp artifacts/macos-amd64/maxx-macOS-amd64.dmg.sha256 release-assets/ 2>/dev/null || echo "macOS amd64 checksum not found"

          # Windows
          cp artifacts/windows-amd64/maxx.exe release-assets/
          cp artifacts/windows-amd64/maxx.exe.sha256 release-assets/

          # Linux
          cp artifacts/linux-amd64/maxx release-assets/
          cp artifacts/linux-amd64/maxx.sha256 release-assets/

          ls -lh release-assets/
      - name: Generate latest.json
        run: |
          VERSION="${{ inputs.tag || github.ref_name }}"
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${VERSION}"

          # Read SHA256 checksums from existing .sha256 files
          WIN_SHA=$(cat release-assets/maxx.exe.sha256 | awk '{print $1}')
          LINUX_SHA=$(cat release-assets/maxx.sha256 | awk '{print $1}')
          MACOS_ARM64_SHA=$(cat release-assets/maxx-macOS-arm64.dmg.sha256 2>/dev/null || echo "")
          MACOS_AMD64_SHA=$(cat release-assets/maxx-macOS-amd64.dmg.sha256 2>/dev/null || echo "")

          cat > release-assets/latest.json << EOF
          {
            "version": "${VERSION}",
            "release_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "files": {
              "windows": {
                "name": "maxx.exe",
                "url": "${BASE_URL}/maxx.exe",
                "sha256": "${WIN_SHA}"
              },
              "darwin-arm64": {
                "name": "maxx-macOS-arm64.dmg",
                "url": "${BASE_URL}/maxx-macOS-arm64.dmg",
                "sha256": "${MACOS_ARM64_SHA}"
              },
              "darwin-amd64": {
                "name": "maxx-macOS-amd64.dmg",
                "url": "${BASE_URL}/maxx-macOS-amd64.dmg",
                "sha256": "${MACOS_AMD64_SHA}"
              },
              "linux": {
                "name": "maxx",
                "url": "${BASE_URL}/maxx",
                "sha256": "${LINUX_SHA}"
              }
            }
          }
          EOF

          echo "Generated latest.json:"
          cat release-assets/latest.json


      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.tag || github.ref_name }}
          files: release-assets/*
          append_body: true
          body: |

            ---

            ## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž

            | å¹³å° | æ–‡ä»¶ | è¯´æ˜Ž |
            |------|------|------|
            | **Windows** | `maxx.exe` | ç›´æŽ¥è¿è¡Œ |
            | **macOS (ARM)** | `maxx-macOS-arm64.dmg` | Apple Silicon (M1/M2/M3) |
            | **macOS (Intel)** | `maxx-macOS-amd64.dmg` | Intel èŠ¯ç‰‡ |
            | **Linux** | `maxx` | åŽŸç”ŸäºŒè¿›åˆ¶ |

            ### ðŸš€ ä½¿ç”¨è¯´æ˜Ž

            **Windows**
            ```bash
            .\maxx.exe
            ```

            **macOS**
            ```bash
            open maxx-macOS-*.dmg
            # æ‹–æ‹½ maxx.app åˆ° Applications æ–‡ä»¶å¤¹
            ```

            > âš ï¸ å¦‚æžœæç¤º"åº”ç”¨å·²æŸå"ï¼Œè¯·è¿è¡Œï¼š
            > ```bash
            > sudo xattr -d com.apple.quarantine /Applications/maxx.app
            > ```

            **Linux**
            ```bash
            chmod +x maxx
            ./maxx
            ```

            ### ðŸ”’ æ–‡ä»¶æ ¡éªŒ
            æ‰€æœ‰å¹³å°å‡æä¾› SHA256 æ ¡éªŒæ–‡ä»¶ï¼ˆ`.sha256`ï¼‰ï¼Œä¸‹è½½åŽå¯éªŒè¯å®Œæ•´æ€§ã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Cask
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ inputs.tag || github.ref_name }}"
          VERSION_NUM="${VERSION#v}"

          # Get SHA256 from release assets
          ARM64_SHA=$(cat release-assets/maxx-macOS-arm64.dmg.sha256)
          AMD64_SHA=$(cat release-assets/maxx-macOS-amd64.dmg.sha256)

          # Generate new cask content
          cat > maxx.rb << 'CASK_EOF'
          cask "maxx" do
            version "VERSION_PLACEHOLDER"

            name "maxx"
            desc "maxx"
            if Hardware::CPU.intel?
              url "https://github.com/awsl-project/maxx/releases/download/v#{version}/maxx-macOS-amd64.dmg"
              sha256 "AMD64_SHA_PLACEHOLDER"
            else
              url "https://github.com/awsl-project/maxx/releases/download/v#{version}/maxx-macOS-arm64.dmg"
              sha256 "ARM64_SHA_PLACEHOLDER"
            end

            homepage "https://github.com/awsl-project/maxx"

            app "maxx.app"
          end
          CASK_EOF

          # Replace placeholders
          sed -i "s/VERSION_PLACEHOLDER/${VERSION_NUM}/g" maxx.rb
          sed -i "s/AMD64_SHA_PLACEHOLDER/${AMD64_SHA}/g" maxx.rb
          sed -i "s/ARM64_SHA_PLACEHOLDER/${ARM64_SHA}/g" maxx.rb

          # Clone homebrew tap and update
          git clone https://x-access-token:${GH_TOKEN}@github.com/awsl-project/homebrew-awsl.git
          cp maxx.rb homebrew-awsl/Casks/maxx.rb

          cd homebrew-awsl
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/maxx.rb
          git commit -m "Update maxx to ${VERSION}" || echo "No changes to commit"
          git push

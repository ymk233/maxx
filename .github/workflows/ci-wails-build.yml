name: Wails Release

on:
  push:
    tags:
      - 'v*'
  workflow_call:
    inputs:
      tag:
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [arm64, amd64]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - uses: pnpm/action-setup@v4

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: cd web && pnpm install

      - name: Build macOS ${{ matrix.arch }}
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          VERSION=${TAG#v}
          wails build -platform darwin/${{ matrix.arch }} -ldflags "-X github.com/awsl-project/maxx/internal/version.Version=$VERSION" -clean

      - name: Create DMG and generate checksum
        run: |
          cd build/bin
          # Find the .app bundle
          APP_NAME=$(ls -d *.app | head -n 1)
          if [ -z "$APP_NAME" ]; then
            echo "App bundle not found" >&2
            ls -la
            exit 1
          fi
          echo "Found app: $APP_NAME"
          
          # Create DMG
          DMG_NAME="maxx-macOS-${{ matrix.arch }}.dmg"
          hdiutil create -volname "maxx" \
            -srcfolder "$APP_NAME" \
            -ov -format UDZO \
            "$DMG_NAME"
          
          # Generate SHA256
          shasum -a 256 "$DMG_NAME" | awk '{print $1}' > "${DMG_NAME}.sha256"
          
          # Move to bin directory
          cd ../..
          mkdir -p bin
          mv "build/bin/$DMG_NAME" bin/
          mv "build/bin/${DMG_NAME}.sha256" bin/
          
          echo "Created: bin/$DMG_NAME"
          ls -lh bin/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: |
            bin/maxx-macOS-${{ matrix.arch }}.dmg
            bin/maxx-macOS-${{ matrix.arch }}.dmg.sha256

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - uses: pnpm/action-setup@v4

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: cd web && pnpm install

      - name: Build Windows Binary
        run: |
          $TAG = "${{ inputs.tag || github.ref_name }}"
          $VERSION = $TAG.TrimStart('v')
          wails build -platform windows/amd64 -ldflags "-X github.com/awsl-project/maxx/internal/version.Version=$VERSION" -clean

      - name: Verify and prepare Binary
        run: |
          # Wails v2 outputs to build/bin
          if (Test-Path "build\bin\maxx.exe") {
            Write-Host "âœ“ Binary found: build\bin\maxx.exe"
            # Copy to bin directory
            New-Item -ItemType Directory -Force -Path bin
            Copy-Item "build\bin\maxx.exe" "bin\maxx.exe"
            Get-Item "bin\maxx.exe" | Format-List Name,Length,LastWriteTime
          } else {
            Write-Host "âœ— Binary not found!"
            Write-Host "Listing build/bin directory:"
            Get-ChildItem build\bin -ErrorAction SilentlyContinue
            exit 1
          }

      - name: Generate SHA256 Checksums
        run: |
          Push-Location bin
          Get-FileHash -Algorithm SHA256 maxx.exe | ForEach-Object { "$($_.Hash.ToLower())  maxx.exe" } | Out-File -Encoding ascii maxx.exe.sha256
          Write-Host "SHA256 checksum generated:"
          Get-Content maxx.exe.sha256
          Pop-Location

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-amd64
          path: |
            bin/maxx.exe
            bin/maxx.exe.sha256

  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Linux Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev

      - uses: pnpm/action-setup@v4

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: cd web && pnpm install

      - name: Build Linux Binary
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          VERSION=${TAG#v}
          wails build -platform linux/amd64 -ldflags "-X github.com/awsl-project/maxx/internal/version.Version=$VERSION" -clean

      - name: Prepare binary
        run: |
          # Wails v2 outputs to build/bin
          mkdir -p bin
          if [ -f "build/bin/maxx" ]; then
            cp build/bin/maxx bin/maxx
            chmod +x bin/maxx
            echo "Binary prepared: bin/maxx"
            ls -lh bin/maxx
          else
            echo "Binary not found!"
            ls -la build/bin/
            exit 1
          fi

      - name: Generate SHA256 Checksum
        run: |
          cd bin
          sha256sum maxx > maxx.sha256
          echo "SHA256 checksum:"
          cat maxx.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-amd64
          path: |
            bin/maxx
            bin/maxx.sha256

  create-release:
    name: Create Release
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # macOS
          cp artifacts/macos-arm64/maxx-macOS-arm64.dmg release-assets/ 2>/dev/null || echo "macOS arm64 not found"
          cp artifacts/macos-arm64/maxx-macOS-arm64.dmg.sha256 release-assets/ 2>/dev/null || echo "macOS arm64 checksum not found"
          cp artifacts/macos-amd64/maxx-macOS-amd64.dmg release-assets/ 2>/dev/null || echo "macOS amd64 not found"
          cp artifacts/macos-amd64/maxx-macOS-amd64.dmg.sha256 release-assets/ 2>/dev/null || echo "macOS amd64 checksum not found"

          # Windows
          cp artifacts/windows-amd64/maxx.exe release-assets/
          cp artifacts/windows-amd64/maxx.exe.sha256 release-assets/

          # Linux
          cp artifacts/linux-amd64/maxx release-assets/
          cp artifacts/linux-amd64/maxx.sha256 release-assets/

          ls -lh release-assets/
      - name: Generate latest.json
        run: |
          VERSION="${{ inputs.tag || github.ref_name }}"
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${VERSION}"

          # Read SHA256 checksums from existing .sha256 files
          WIN_SHA=$(cat release-assets/maxx.exe.sha256 | awk '{print $1}')
          LINUX_SHA=$(cat release-assets/maxx.sha256 | awk '{print $1}')
          MACOS_ARM64_SHA=$(cat release-assets/maxx-macOS-arm64.dmg.sha256 2>/dev/null || echo "")
          MACOS_AMD64_SHA=$(cat release-assets/maxx-macOS-amd64.dmg.sha256 2>/dev/null || echo "")

          cat > release-assets/latest.json << EOF
          {
            "version": "${VERSION}",
            "release_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "files": {
              "windows": {
                "name": "maxx.exe",
                "url": "${BASE_URL}/maxx.exe",
                "sha256": "${WIN_SHA}"
              },
              "darwin-arm64": {
                "name": "maxx-macOS-arm64.dmg",
                "url": "${BASE_URL}/maxx-macOS-arm64.dmg",
                "sha256": "${MACOS_ARM64_SHA}"
              },
              "darwin-amd64": {
                "name": "maxx-macOS-amd64.dmg",
                "url": "${BASE_URL}/maxx-macOS-amd64.dmg",
                "sha256": "${MACOS_AMD64_SHA}"
              },
              "linux": {
                "name": "maxx",
                "url": "${BASE_URL}/maxx",
                "sha256": "${LINUX_SHA}"
              }
            }
          }
          EOF

          echo "Generated latest.json:"
          cat release-assets/latest.json


      - name: Generate release body
        run: |
          TAG="${{ inputs.tag || github.ref_name }}"
          VERSION=${TAG#v}
          echo "Generating release body for Maxx v$VERSION"

          cat > /tmp/release_body.md << 'EOF'
          ## ðŸŽ‰ Maxx - AI API Gateway & Proxy

          ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž

          | å¹³å° | æ–‡ä»¶ | è¯´æ˜Ž |
          |------|------|------|
          | **Windows** | `maxx.exe` | ç›´æŽ¥è¿è¡Œ |
          | **macOS (ARM)** | `maxx-macOS-arm64.dmg` | Apple Silicon (M1/M2/M3) |
          | **macOS (Intel)** | `maxx-macOS-amd64.dmg` | Intel èŠ¯ç‰‡ |
          | **Linux** | `maxx` | åŽŸç”ŸäºŒè¿›åˆ¶ |

          ### ðŸš€ ä½¿ç”¨è¯´æ˜Ž

          **Windows**
          ```bash
          # ç›´æŽ¥è¿è¡Œ
          .\maxx.exe
          ```

          **macOS**
          ```bash
          # æ‰“å¼€ DMG æ–‡ä»¶ï¼Œæ‹–æ‹½ maxx.app åˆ° Applications æ–‡ä»¶å¤¹
          open maxx-macOS-*.dmg
          ```

          **Linux**
          ```bash
          # æ·»åŠ æ‰§è¡Œæƒé™åŽè¿è¡Œ
          chmod +x maxx
          ./maxx
          ```

          ### ðŸ”’ æ–‡ä»¶æ ¡éªŒ
          æ‰€æœ‰å¹³å°å‡æä¾› SHA256 æ ¡éªŒæ–‡ä»¶ï¼ˆ`.sha256`ï¼‰ï¼Œä¸‹è½½åŽå¯éªŒè¯å®Œæ•´æ€§ï¼š
          
          ```bash
          # Linux/macOS
          sha256sum -c maxx.sha256
          shasum -a 256 -c maxx-macOS-arm64.dmg.sha256

          # Windows PowerShell
          (Get-FileHash maxx.exe).Hash -eq (Get-Content maxx.exe.sha256).Split()[0]
          ```

          ### ðŸ“ æ›´æ–°å†…å®¹
          è¯·æŸ¥çœ‹ [æäº¤åŽ†å²](https://github.com/${{ github.repository }}/commits) äº†è§£è¯¦ç»†æ›´æ–°ã€‚
          EOF

          echo "Generated release body:"
          cat /tmp/release_body.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*
          body_path: /tmp/release_body.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
